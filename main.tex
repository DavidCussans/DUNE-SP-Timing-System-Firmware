% XeLaTeX style packages

\documentclass{dune}
\usepackage[utf8]{inputenc}
%\usepackage{lineno}
\usepackage{graphicx}
%\usepackage{xcolor}

\usepackage{float}

\usepackage{xspace}

% if we aren't using the DUNE class then we need the packages...
%\usepackage{siunitx}
% end of packages included instead of using DUNE

\input{units.tex}
\usepackage[hidelinks]{hyperref}
\input{defs.tex}
\input{glossary.tex}

\usepackage{biblatex}
\addbibresource{bibliography.bib}

\usepackage{minted}

%\documentclass[a4paper,11pt]{article}
%\usepackage{minted}
%\usepackage{listings}
%\usepackage{pdflscape}
%\usepackage{fontspec}
%\defaultfontfeatures{Ligatures=TeX}
% \setmainfont{Liberation Serif}
%\usepackage{microtype}
%\frenchspacing
%\usepackage{enumitem}
%\usepackage{color}
%\usepackage{geometry}
%\usepackage{graphicx}
%\usepackage{booktabs}
%\usepackage{multirow}
%\usepackage{hyperref}
%\usepackage[backend=bibtex]{biblatex}
%\addbibresource{bibliography.bib}
%\bibliography{refs}

\begin{document}

\lstset{
    frameround=fttt,
    language=VHDL,
    numbers=left,
    breaklines=true,
    keywordstyle=\color{blue}\bfseries, 
    basicstyle=\ttfamily\color{red},
    numberstyle=\color{black}
    }

\lstMakeShortInline[columns=fixed]|


%\lstset{
%    frameround=fttt,
%    language=VHDL,
%    numbers=left,
%    breaklines=true,
%    keywordstyle=\color{blue}\bfseries, 
%    basicstyle=\ttfamily\color{red},
%    numberstyle=\color{black}
%    }

%\lstMakeShortInline[columns=fixed]|

\title{DUNE-SP Timing System: Firmware}
\begin{center}
{\LARGE\bf DUNE-SP Timing System Firmware Description}
\vspace{1cm}

J. Brooke, D. Cussans, D. Newbold, S. Trilov \\
\vspace*{1ex}
v1 -- 1st June 2020
\end{center}
\vspace*{\fill}
\setcounter{tocdepth}{1}
\tableofcontents
\vspace*{\fill}

\section{Summary}

This document describes the structure of the firmware used in the DUNE-SP timing system. The protocol used for message transmission is described elsewhere\cite{ref:dts-sp-timing-protocol}

It is intended to be updated periodically as the specification is finalised and amended.

\newpage
\section{Overview}

This document describes the structure of the timing system firmware. There are two main components - the \dword{dts-sp-tm} and \dword{dts-sp-ep}

\section{Timing Master}

The structure of the timing master firmware follows the conventions of a typical \dword{ipbb} project.

\section{Timing Endpoint Interface}

A timing endpoint is characterised by the following properties:

\begin{itemize}
	\item A single system clock phase, adjustable under timing system control
	\item A unique address
	\item A timing group mask
\end{itemize}

A conceptual diagram of an endpoint is shown in Figure~\ref{fig:fw_if}. It consists of three major components and one optional component:

\begin{itemize}
	\item A clock and data recovery IC (e.g. ADN2814). This component is not required for endpoints with a clock + data interface.
	\item A PLL for jitter reduction and phase adjustment, with the latter function controlled from the endpoint FPGA. The PLL may be implemented as an internal clock controller (e.g. MMCM) within the FPGA, or may be an external component. This component is not required for endpoints with a clock + data interface, since phase may be controlled by the optical-LVDS converter module if necessary.
	\item A firmware protocol decoder, implemented inside the FPGA as part of the overall system firmware. This block receives and interprets the timing data stream, and provides decoded commands to other blocks inside the FPGA. It also monitors and counts errors observed in the data stream.
	\item(optional) For high precision phase alignment ( $< 1{\mathrm ns}$) a high speed D-type flip-flop should be used to re-time the outgoing data stream onto the master 312.5MHz clock.
\end{itemize}

Error conditions monitored by the decoder include:

\begin{itemize}
	\item 8b/10b decoder errors
	\item Packet checksum errors
	\item Counter-out-of-sync error
	\item CDR / PLL lock timeout
\end{itemize}

The status of the decoder may be monitored locally via the status flags (see below), or for soft errors, remotely via the A\_Status command. An endpoint that is in error can be reset locally or via the timing system, and then brought back into synchronisation with the rest of the system at the next S\_Sync command.

\begin{figure}[p]
	\centering
	\includegraphics[width=0.9\textwidth]{timing_endpoint_block.pdf}
	\caption{Endpoint signal paths. Signals in red are data and clock. Signals in black are control and monitoring}
	\label{fig:fw_if}
\end{figure}

\subsection{Endpoint Firmware Interface}

The decoder block exposes three sets of signals:

\subsubsection{\textcolor{red}{sys\_clk} domain signals}

\begin{itemize}
	\item |sys_clk| (o) is the free-running local clock provided by the host FPGA
	\item |sys_rst| (i) is a startup synchronous reset signal
	\item |address| (i) is a 16b word specifying: the address identifying this endpoint (see above for addressing scheme); and the timing group mask. It should not change once |sys_rst| is released.
	\item |status| (o, 4b) is a set of output signals indicating the internal state of the decoder, including: whether the core is in contact with the timing master; is in one of several possible setup or error conditions; is providing a stable global clock. The signal may be used to drive a reset of all logic governed by the global clock.
\end{itemize}

{\color{red}FUTURE\_UPDATE} Write state transition diagram for the decoder.

%\subsubsection{\textcolor{red}{Global\_clk} domain signals}
\subsubsection{\textcolor{red}{Global clk} domain signals}

\begin{itemize}
	\item |global_clk| (i) is the phase-adjusted 62.5MHz system clock from the PLL
	\item |sync| (o, 16b) is a set of bits corresponding to decoded fixed length messages. These bits go high for one clock cycle on receipt of the corresponding fixed length message.
	\item |cmd| (o, 8b) is a byte-wide output carrying a copy of received packet data addressed to this endpoint.
	\item |strobe| (o) is a signal qualifying the validity of the |cmd| output. It stays high for an entire packet of data, then goes low at the end of the packet.
	\item |timestamp| (o, 64b) is the 64b system cycle counter, cycling at global clock frequency.
\end{itemize}

\subsubsection{Other signals}

\begin{itemize}
	\item |data| (i) is the recovered or received serial timing data stream. This signal is automatically registered on the rising or falling edge of |global_clk| in order to cope with arbitrary phase alignment.
	\item |cdr_lock| (i) is the lock status signal of the CDR chip
	\item |pll_lock| (i) is the lock status of the PLL
	\item |pll_adj| (o, 8b) is a word indicating the desired phase adjustment for global\_clock. The physical interface to the PLL is implemented by the host FPGA, since this may require communication via a range of means to the PLL depending on implementation.
\end{itemize}

\clearpage

\appendix

\section{DTS-SP Firmware, Software}

At the time of writing, DTS-SP firmware is hosted at \url{https://gitlab.cern.ch/protoDUNE-SP-DAQ/timing-board-firmware} . Scripts to test and configure the timing system firmware are hosted at \url{https://gitlab.cern.ch/protoDUNE-SP-DAQ/timing-board-software}



\section{Example Endpoint Firmware}

\subsection{Interface to Example Endpoint Firmware }

The top-level declaration for the endpoint entity is:

\begin{minted}{vhdl}
entity pdts_endpoint is
  generic(
    SCLK_FREQ : real    := 62.5;        -- Frequency (MHz) of the supplied sclk
                                        -- ( 62.5MHz for DUNE , 50MHz for ProtoDUNE-1 )
    EN_TX     : boolean := false        -- Enable endpoint to originate messages.
                                        -- Only for ETI (CTB in ProtoDUNE-1)
    );
  port(
    sclk       : in  std_logic;         -- Free-running system clock
    srst       : in  std_logic;         -- System reset (sclk domain)
    addr       : in  std_logic_vector(15 downto 0);  -- Endpoint address
                                                    -- (async, sampled in clk domain)
    tgrp       : in  std_logic_vector(1 downto 0);  -- Timing group
                                                    -- (async, sampled in clk domain)
    stat       : out std_logic_vector(3 downto 0);  -- Status output (sclk domain)
    rec_clk    : in  std_logic;         -- CDR recovered clock from timing link
    rec_d      : in  std_logic;         -- CDR recovered data from timing link
                                        -- (rec_clk domain)
    txd        : out std_logic;         -- Output data to timing link
                                        -- (rec_clk domain)
    sfp_los    : in  std_logic := '0';  -- SFP LOS line
                                        -- (async, sampled in sclk domain)
    cdr_los    : in  std_logic := '0';  -- CDR LOS line
                                        -- (async, sampled in sclk domain)
    cdr_lol    : in  std_logic := '0';  -- CDR LOL line
                                        -- (async, sampled in sclk domain)
    sfp_tx_dis : out std_logic;         -- SFP tx disable line (clk domain)
    clk        : out std_logic;         -- 62.5MHz clock output
    rst        : out std_logic;         -- 62.5MHz domain reset
    rdy        : out std_logic;         -- Timestamp valid flag
    sync       : out std_logic_vector(SCMD_W - 1 downto 0);  -- fixed-length command
                                                             -- output (clk domain)
    sync_stb   : out std_logic;         -- fixed length command strobe (clk domain)
    sync_valid : out std_logic;         -- fixed length command valid flag (clk domain)
    tstamp     : out std_logic_vector(8 * TSTAMP_WDS - 1 downto 0);  -- Timestamp out
    tsync_in   : in  cmd_w     := CMD_W_NULL;       -- Tx fixed-length command input
    tsync_out  : out cmd_r              -- Tx fixed-length command handshake
    );


end pdts_endpoint;
\end{minted}

Where the ports are as described below:

\begin{itemize}
    

\item |SCLK_FREQ| should be set to the frequency of the supplied system clock ``sclk'' in MHz

\item |EN_TX| should be left at the default of false unless the endpoint is to be a source of messages rather than responding to them. Only set true for ETI in DUNE, or CTB in ProtoDUNE

\item |sclk| is a free-running system clock at a frequency of your choice. There is no clock
buffering or other manipulation inside the endpoint block.

\item |srst| is a synchronous reset (|sclk| domain) that should be held high until |sclk |is stable
and the configuration signals to the endpoint are ready. Asserting this signal will cause
the endpoint to begin its initialisation sequence again

\item |addr| is an eight-bit address that should be unique for each endpoint in the system.
Set to all-zeroes for now.

\item |tgrp| is a two-bit address that sets the timing group (or 'partition') that this instance
of the endpoint is a member of. You probably need to set this from a register in your
design.

\item |stat| (|sclk| domain) indicates the status of the endpoint (you can find the meaning of the states
in |pdts_ep_startup.vhd|. This is provided only for debugging purposes. You should use the
|rdy| signal to indicate to your firmware when the signals from the endpoint are valid.

\item |rec_clk| is the recovered clock from the CDR device (or from the clock line in case of separate clock and data lines)

\item |rec_d| is the recovered data from the CDR device (or from the serial data line in case of separate clock and data).

\item |txd| is the output data from the endpoint back to the master. Register this with the your local DTS-SP clock and connect to your
SFP data input (or the ``copper'' signal lines if using direct connection).

\item |sfp_los| should be connected to the corresponding line on the SFP (for systems
not using an SFP, leave unconnected).

\item |cdr_los| should be connected to the corresponding line on the CDR chip (for systems not using
CDR, leave unconnected).

\item |cdr_lol| should be connected to the corresponding line on the CDR chip (for systems not using
CDR, leave unconnected).

\item |sfp_tx_dis| should be connected to the corresponding transmit disable line on the SFP

\item |clk| is the phase-adjusted 62.5MHz DUNE (50MHz ProtoDUNE) system clock

\item |rst| is a synchronous reset (|clk| domain) to your logic, asserted until the phase of |clk|
is stable.

\item |rdy| (|clk| domain) indicates that the endpoint is running, and that output signals are
valid. Until |rdy| is asserted, the |tstamp| may change randomly, and sync commands are
meaningless.

\item |sync| (|clk| domain) is the fixed-length (synchronous) command output from the endpoint. The table of current
command codes can be found in |pdts_defs.vhd|.

\item |sync_stb| (|clk| domain) is the strobe for sync, and is asserted each time a new data word is
written to sync. Note that commands can be longer than one word long.

\item |sync_valid| (|clk| domain) is asserted on the first word of each fixed-length command. If your firmware only
cares about the first word of each command (e.g. if you only listen to trigger
commands, you can treat this as the qualifying signal for sync, and ignore
subsequent words of commands).

\item |tstamp| (|clk| domain) is the system-wide 64b timestamp.

\item |tsync_in| (|clk| domain) is the interface for sending fixed length (synchronous) commands back to the master, and should
only be used by the ETI in DUNE (CTB in ProtoDUNE). Others should leave it disconnected.

\item |tsync_out| (|clk| domain) is the handshaking signals accompanying |tsync_in|, and should
only be used by the ETI in DUNE (CTB in ProtoDUNE).

\end{itemize}

In order to assist in decoding the fixed length commands at ProtoDUNE-1, a utility block is provided in
|components/pdts/firmware/hdl/pdts_ep_decoder.vhd|:

\begin{minted}{vhdl}
entity pdts_ep_decoder is
  port(
    clk      : in  std_logic;           -- 62.5MHz clock (50MHz ProtoDUNE)
    rst      : in  std_logic;           -- Sync reset
    rdy      : in  std_logic;           -- Timing system up flag
    scmd     : in  std_logic_vector(SCMD_W - 1 downto 0);  -- fixed length
                                                           -- command input
    scmd_v   : in  std_logic;           -- fixed length command valid flag
    in_spill : out std_logic;           -- Spill flag (ProtoDUNE)
    in_run   : out std_logic;           -- Run flag (ProtoDUNE)
    evtctr   : out std_logic_vector(8 * EVTCTR_WDS - 1 downto 0)  -- Event counter
    );

\end{minted}
%\section{Link Finite State Machine}

\clearpage
\printbibliography

\end{document}
 